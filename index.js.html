<script>
function isLineBreak(phrases) {
    for (var i = 0; i < phrases.length; i++) {
       if("改行" == phrases[i]) {
          return true;
       }
       if("開業" == phrases[i]) {
          return true;
       }
       if("戒名" == phrases[i]) {
          return true;
       }
       if("MARU" == phrases[i]) {
          return true;
       }       
    }
    return false;
}
function isPhrasesPunctuation(phrases) {
    for (var i = 0; i < phrases.length; i++) {
       if("まる" == phrases[i]) {
          return true;
       }
       if("丸" == phrases[i]) {
          return true;
       }
       if("マル" == phrases[i]) {
          return true;
       }
       if("MARU" == phrases[i]) {
          return true;
       }       
    }
    return false;
}
function isPhrasesReading(phrases) {
    for (var i = 0; i < phrases.length; i++) {
       if("10" == phrases[i]) {
          return true;
       }
       if("天" == phrases[i]) {
          return true;
       }
       if("てん" == phrases[i]) {
          return true;
       }
       if("店" == phrases[i]) {
          return true;
       }       
       if("テン" == phrases[i]) {
          return true;
       }       
    }
    return false;
}
if (!annyang) {
    $('.no-browser-support').show();
    $('.app').hide();
} else {
    annyang.debug(true);
    annyang.setLanguage('ja-JP');
    var noteTextarea = $('#note-textarea');
    var notesList = $('ul#notes');
    var noteContent = '';
    var notes = getAllNotes();
    renderNotes(notes);
    annyang.addCallback('result', function(phrases) {
        if (isPhrasesReading(phrases)) {
            noteContent += "、";   
        } else if (isPhrasesPunctuation(phrases)) {
            noteContent += "。";           
        } else if (isLineBreak(phrases)) {
            noteContent += "\r\n";           
        } else {
            noteContent += phrases[0];
        }
        noteTextarea.val(noteContent);
        noteTextarea.focus();
        noteTextarea.setSelectionRange(noteTextarea.value.length, noteTextarea.value.length);
    });
    annyang.addCallback('start', function() {
        // Do Nothing...
    });
    annyang.addCallback('end', function() {
        // Do Nothing...    
    });                
    annyang.addCallback('error', function(event) {
        if(event.error == 'no-speech') {
        // Do Nothing...    
        };
    });
    /*-----------------------------
        App buttons and input 
    ------------------------------*/
    // Sync the text inside the text area with the noteContent variable.
    noteTextarea.on('input', function() {
        noteContent = $(this).val();
    });

    $('#save-note-btn').on('click', function(e) {
        annyang.abort();
        if(!noteContent.length) {
            // Do Nothing...    
        } else {
            // Save note to localStorage.
            // The key is the dateTime with seconds, the value is the content of the note.
            saveNote(new Date().toLocaleString(), noteContent);

            // Reset variables and update UI.
            noteContent = '';
            renderNotes(getAllNotes());
            noteTextarea.val('');
            // Do Nothing...    
        }  
    });
    
    $('#export-note-btn').on('click', function(e) {
        if($(".note").length > 0) {
            var ret = window.prompt('ドキュメント名を入力してください。');
            if(!ret) {
                return false;
            }
            var data = new Object();
            var contents = new Array();
            var notes = $(".note");
            for (var i = 0; i < notes.length; i++) {
                var note = notes[i];
                var elem = new Object();
                elem.heading = $(".header .date", note).text();
                elem.content = $(note).children(".content").text();
                contents.push(elem);
            }
            data.documentName = ret;
            data.notes = contents;
            google.script.run.withSuccessHandler(noticeSuccess).exportToGoogleDocument(data);            
        }
    });
    
    notesList.on('click', function(e) {
        e.preventDefault();
        var target = $(e.target);

        // Listen to the selected note.
        if(target.hasClass('listen-note')) {
            var content = target.closest('.note').find('.content').text();
            readOutLoud(content);
        }

        // Delete note.
        if(target.hasClass('delete-note')) {
            var dateTime = target.siblings('.date').text();  
            deleteNote(dateTime);
            target.closest('.note').remove();
        }
    });
    // Tell KITT to use annyang
    SpeechKITT.annyang();
    SpeechKITT.setToggleLabelText('録音する');
    SpeechKITT.setInstructionsText('録音中しています...');
    // Define a stylesheet for KITT to use
    SpeechKITT.setStylesheet('//cdnjs.cloudflare.com/ajax/libs/SpeechKITT/1.0.0/themes/flat-concrete.css');
    // Render KITT's interface
    SpeechKITT.vroom();
}
/*-----------------------------
    Speech Synthesis 
------------------------------*/
function noticeSuccess(url) {
    window.alert('エクスポートが完了しました。 url [' + url + ']');
}
function readOutLoud(message) {
    var speech = new SpeechSynthesisUtterance();

// Set the text and voice attributes.
    speech.text = message;
    speech.volume = 1;
    speech.rate = 1;
    speech.pitch = 1;  
    window.speechSynthesis.speak(speech);
}

/*-----------------------------
    Helper Functions 
------------------------------*/
function renderNotes(notes) {
    var html = '';
    if(notes.length) {
        notes.forEach(function(note) {
        html+= `<li class="note">
            <p class="header">
            <span class="date">${note.date}</span>
            <a href="#" class="listen-note" title="Listen to Note">Listen to Note</a>
            <a href="#" class="delete-note" title="Delete">Delete</a>
            </p>
            <p class="content">${note.content}</p>
        </li>`;    
        });
    }
    else {
        html = '<li><p class="content">You don\'t have any notes yet.</p></li>';
    }
    notesList.html(html);
}
function saveNote(dateTime, content) {
    localStorage.setItem('note-' + dateTime, content);
}
function getAllNotes() {
    var notes = [];
    var key;
    for (var i = 0; i < localStorage.length; i++) {
        key = localStorage.key(i);

        if(key.substring(0,5) == 'note-') {
        notes.push({
            date: key.replace('note-',''),
            content: localStorage.getItem(localStorage.key(i))
        });
        } 
    }
    return notes;
}
function deleteNote(dateTime) {
    localStorage.removeItem('note-' + dateTime); 
}
</script>